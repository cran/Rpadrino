<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Modifying Stochastic IPMs in PADRINO</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Modifying Stochastic IPMs in PADRINO</h1>


<div id="TOC">
<ul>
<li><a href="#modifying-the-environment-of-a-padrino-ipm">Modifying the
environment of a PADRINO IPM</a>
<ul>
<li><a href="#finding-parameter-resampled-ipms">Finding
parameter-resampled IPMs</a></li>
</ul></li>
<li><a href="#re-set-environmental-variables-w-pre-defined-sequence-of-values">re-set
environmental variables w/ pre-defined sequence of values</a>
<ul>
<li><a href="#create-the-proto_ipms-and-find-the-stochastic-parameter-names">Create
the proto_ipm’s and find the stochastic parameter names</a></li>
<li><a href="#create-new-stochastic-parameter-values">Create new
stochastic parameter values</a></li>
<li><a href="#write-our-sampling-function">Write our sampling
function</a></li>
<li><a href="#remove-the-current-environmental-variation">Remove the
current environmental variation</a></li>
<li><a href="#insert-our-environmental-variation">Insert our
environmental variation</a></li>
<li><a href="#rebuild-the-models">Rebuild the models</a></li>
</ul></li>
<li><a href="#modifying-parameter-values">Modifying parameter values</a>
<ul>
<li><a href="#identify-parameter-names">Identify parameter
names</a></li>
</ul></li>
<li><a href="#changing-distributions">Changing distributions</a>
<ul>
<li><a href="#top-level-function">Top-level function</a></li>
<li><a href="#substituting-functions">Substituting functions</a></li>
</ul></li>
</ul>
</div>

<div id="modifying-the-environment-of-a-padrino-ipm" class="section level1">
<h1>Modifying the environment of a PADRINO IPM</h1>
<p>Sometimes, we may want to modify the environmental sequence of a
stochastic IPM stored in PADRINO. As of now, there is no single interace
for doing this, and so you may need to write some code on your own. This
vignette is meant to provide a bit of help with that. It will make use
of <code>Rpadrino</code> and <code>ipmr</code> to modify
<code>proto_ipm</code>s, and doesn’t assume any prior knowledge of the
data structure or of PADRINO itself (I don’t think, anyway. Let me know
if I’m incorrect via a <a href="https://github.com/padrinoDB/Rpadrino/issues">Github
Issue</a>).</p>
<div id="finding-parameter-resampled-ipms" class="section level2">
<h2>Finding parameter-resampled IPMs</h2>
<p>These aren’t explicitly marked in the Metadata table. However, we can
find them by searching the <code>EnvironmentalVariables</code> table,
specifically the <code>ipm_id</code> column.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rpadrino)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pdb <span class="ot">&lt;-</span> <span class="fu">pdb_download</span>(<span class="cn">FALSE</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(pdb<span class="sc">$</span>EnvironmentalVariables<span class="sc">$</span>ipm_id)</span></code></pre></div>
<pre><code>## [1] &quot;aaaa15&quot; &quot;aaaa16&quot; &quot;aaaa21&quot; &quot;aaaa54&quot; &quot;aaaa59&quot;</code></pre>
<p>For now, we’ll just work with the two IPMs from Westerband et
al. (2016):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>stoch_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;aaaa15&quot;</span>, <span class="st">&quot;aaaa16&quot;</span>)</span></code></pre></div>
<p>Ok, now we have the data we want to work with, we can check out
various ways of modifying them to explore the questions we want to
answer!</p>
</div>
</div>
<div id="re-set-environmental-variables-w-pre-defined-sequence-of-values" class="section level1">
<h1>re-set environmental variables w/ pre-defined sequence of
values</h1>
<p>First, we’ll examine how to re-set IPMs to sample from a
pre-determined sequence of environmental values. This is useful for
exploring things like, for example, environmental autocorrelation and/or
enhancing reproducibility of our subsequent analyses.</p>
<p>This will require a few steps:</p>
<ol style="list-style-type: decimal">
<li><p>Create <code>proto_ipm</code> objects from the PADRINO
data.</p></li>
<li><p>Remove the current stochastic environmental state
expressions</p></li>
<li><p>Replace them with something that will generate the values we
want.</p></li>
</ol>
<div id="create-the-proto_ipms-and-find-the-stochastic-parameter-names" class="section level2">
<h2>Create the proto_ipm’s and find the stochastic parameter names</h2>
<p>First, we should investigate what’s in each model by creating and
printing the <code>proto_ipm</code>s.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1 - create proto_ipms, and then figure out which parameters in the</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># vital rate expressions we need to work with.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>protos <span class="ot">&lt;-</span> <span class="fu">pdb_make_proto_ipm</span>(pdb, stoch_ids)</span></code></pre></div>
<pre><code>## &#39;ipm_id&#39; aaaa15 has resampled parameters, resetting &#39;det_stoch&#39; to &#39;stoch&#39; and 
## &#39;kern_param&#39; to &#39;param&#39;!
## Default number of iterations for &#39;pdb_make_ipm&#39; will be 50. Modify this behavior 
## with the &#39;addl_args&#39; argument of &#39;pdb_make_ipm&#39;.</code></pre>
<pre><code>## &#39;ipm_id&#39; aaaa16 has resampled parameters, resetting &#39;det_stoch&#39; to &#39;stoch&#39; and 
## &#39;kern_param&#39; to &#39;param&#39;!
## Default number of iterations for &#39;pdb_make_ipm&#39; will be 50. Modify this behavior 
## with the &#39;addl_args&#39; argument of &#39;pdb_make_ipm&#39;.</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>protos[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## A simple, density independent, stochastic, parameter-resampled proto_ipm with 2 kernels defined:
##  P, F 
## 
## Kernel formulae:
## 
## P: s * g
## F: f
## 
## Vital rates:
## 
## s: 1/(1 + exp(-(s_0 + s_1 * leafarea_1 + s_2 * j + s_3 * leafarea_1 * 
##     j)))
## g_mu: g_0 + g_1 * leafarea_1 + g_2 * j + g_3 * A_max + g_4 * leafarea_1 * 
##     j + g_5 * leafarea_1 * A_max + g_6 * j * A_max + g_7 * leafarea_1 * 
##     j * A_max
## g: dnorm(leafarea_2, g_mu, g_sd)
## f: r_p * r_o * n_f * n_s * s_s * sdl_s * sdl_size
## r_p: 1/(1 + exp(-(r_0 + r_1 * leafarea_1 + r_2 * j + r_3 * leafarea_1 * 
##     j)))
## r_o: exp(i_0 + i_1 * leafarea_1 + i_2 * j + i_3 * leafarea_1 * j)
## s_s: ifelse(j &lt; 6, s_sl, s_sh)
## sdl_s: ifelse(j &lt; 6, sdl_sl, sdl_sh)
## sdl_size: ifelse(j &lt; 6, sdl_m_l, sdl_m_h)
## sdl_m_l: dnorm(leafarea_2, sdl_meanl, sdl_sdl)
## sdl_m_h: dnorm(leafarea_2, sdl_meanh, sdl_sdh)
## 
## Parameter names:
## 
##  [1] &quot;s_0&quot;       &quot;s_1&quot;       &quot;s_2&quot;       &quot;s_3&quot;       &quot;g_0&quot;       &quot;g_1&quot;      
##  [7] &quot;g_2&quot;       &quot;g_3&quot;       &quot;g_4&quot;       &quot;g_5&quot;       &quot;g_6&quot;       &quot;g_7&quot;      
## [13] &quot;g_sd&quot;      &quot;r_0&quot;       &quot;r_1&quot;       &quot;r_2&quot;       &quot;r_3&quot;       &quot;i_0&quot;      
## [19] &quot;i_1&quot;       &quot;i_2&quot;       &quot;i_3&quot;       &quot;n_f&quot;       &quot;n_s&quot;       &quot;s_sl&quot;     
## [25] &quot;s_sh&quot;      &quot;sdl_sl&quot;    &quot;sdl_sh&quot;    &quot;sdl_meanl&quot; &quot;sdl_meanh&quot; &quot;sdl_sdl&quot;  
## [31] &quot;sdl_sdh&quot;  
## 
## All parameters in vital rate expressions found in &#39;data_list&#39;:  FALSE
## Did not test parameters in &#39;define_env_state()&#39;.
## 
## Items in vital rate expressions not found in &#39;data_list&#39;:
## 
## *P*
## j
## A_max 
## 
## *F*
## j 
## 
## This may be because &#39;define_domains()&#39; has not yet been called.
##  If it has been called, then double check the model definition and &#39;data_list&#39;.
## 
## 
## Domains for state variables:
## 
## leafarea: lower_bound = 0.57, upper_bound = 11.9, n_meshpoints = 50
## 
## Population states defined:
## 
## n_leafarea: Pre-defined population state.
## 
## Internally generated model iteration procedure:
## 
## n_leafarea_t_1: right_mult(kernel = P, vectr = n_leafarea_t) + right_mult(kernel = F, 
##     vectr = n_leafarea_t)</code></pre>
<p>It seems that <code>j</code> and <code>A_max</code> are the two that
we need to create sequences for. Let’s double check the
<code>EnvironmentalVariables</code> table to be sure:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>pdb<span class="sc">$</span>EnvironmentalVariables[pdb<span class="sc">$</span>EnvironmentalVariables<span class="sc">$</span>ipm_id <span class="sc">%in%</span> stoch_ids, ]</span></code></pre></div>
<table>
<caption>EnvironmentalVariables Table, subsetted using
‘stoch_ids’</caption>
<colgroup>
<col width="8%" />
<col width="15%" />
<col width="15%" />
<col width="12%" />
<col width="33%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">ipm_id</th>
<th align="left">env_variable</th>
<th align="left">vr_expr_name</th>
<th align="left">env_range</th>
<th align="left">env_function</th>
<th align="left">model_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">LightLevel</td>
<td align="left">j</td>
<td align="left">NULL</td>
<td align="left">sample(j_seq)</td>
<td align="left">Substituted</td>
</tr>
<tr class="even">
<td align="left">aaaa15</td>
<td align="left">LightLevel</td>
<td align="left">j_seq</td>
<td align="left">1:5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">A_max</td>
<td align="left">NULL</td>
<td align="left">Unif(a_max_low, a_max_high)</td>
<td align="left">Substituted</td>
</tr>
<tr class="even">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">a_max_low</td>
<td align="left">5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">a_max_high</td>
<td align="left">7</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="even">
<td align="left">aaaa16</td>
<td align="left">LightLevel</td>
<td align="left">j</td>
<td align="left">NULL</td>
<td align="left">sample(j_seq)</td>
<td align="left">Substituted</td>
</tr>
<tr class="odd">
<td align="left">aaaa16</td>
<td align="left">LightLevel</td>
<td align="left">j_seq</td>
<td align="left">1:5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="even">
<td align="left">aaaa16</td>
<td align="left">A_max</td>
<td align="left">A_max</td>
<td align="left">NULL</td>
<td align="left">Unif(a_max_low, a_max_high)</td>
<td align="left">Substituted</td>
</tr>
<tr class="odd">
<td align="left">aaaa16</td>
<td align="left">A_max</td>
<td align="left">a_max_low</td>
<td align="left">5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="even">
<td align="left">aaaa16</td>
<td align="left">A_max</td>
<td align="left">a_max_high</td>
<td align="left">8</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
</tbody>
</table>
</div>
<div id="create-new-stochastic-parameter-values" class="section level2">
<h2>Create new stochastic parameter values</h2>
<p>Next, we need to simulate values for <code>j</code> and
<code>A_max</code>. This next chunk replicates what PADRINO is doing in
a simulation, it just does the sampling ahead of time. In your own code,
you’ll want to replace it with, say, creating autocorrelated sequences
of vectors, or a specific climate change scenario.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>use_j <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">size =</span> <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>use_a <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">50</span>, <span class="dv">5</span>, <span class="dv">8</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The names of this data.frame need to be the same as the names of the variables</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># we&#39;re substituting in the IPM. Otherwise, the function we write in the next</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># block won&#39;t work!</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>use_env_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">j =</span> use_j, <span class="at">A_max =</span> use_a)</span></code></pre></div>
</div>
<div id="write-our-sampling-function" class="section level2">
<h2>Write our sampling function</h2>
<p>We now have our values! But how to insert them and then run the
model? We need to write a function that samples these values in the
order we want, and then sets their names correctly. It should return a
named list. For this example, we’ll assume that above, we created them
in the correct order, and that each row of the resulting
<code>data.frame</code> corresponds to a time step. For now, don’t worry
about where <code>index</code> will come from - that will become clear
shortly.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sample_env <span class="ot">&lt;-</span> <span class="cf">function</span>(env_data, index) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>(env_data[index, ]) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="fu">names</span>(env_data))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="remove-the-current-environmental-variation" class="section level2">
<h2>Remove the current environmental variation</h2>
<p>We’re ready to begin working with the actual <code>proto_ipm</code>
objects! For now, we’ll just modify the first one. The first step is to
eliminate the current environmental information from the
<code>proto_ipm</code>. That information is stored in the
<code>env_state</code> column. By default, it is <code>NA</code> unless
there is a continuous environmental variation, so we want to re-set it
to that state before we insert our own information.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For this demonstration, we&#39;ll create copy in the &#39;protos&#39; object and overwrite</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># that.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>protos<span class="sc">$</span>aaaa15_2 <span class="ot">&lt;-</span> protos<span class="sc">$</span>aaaa15</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>protos<span class="sc">$</span>aaaa15_2<span class="sc">$</span>env_state <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  protos<span class="sc">$</span>aaaa15_2<span class="sc">$</span>env_state, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># In practice, you may just want to to overwrite the proto_ipm object in place.</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># We can still recover the object by re-building the proto_ipm list from the</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># intact version of the &#39;pdb&#39; object.</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># protos$aaaa15$env_state &lt;- lapply(</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   protos$aaaa15$env_state, </span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   function(x) return(NA)</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to do get rid of both at the same time, use a double-lapply:</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># protos &lt;- lapply(protos, </span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                  function(x) {</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                    x$env_state &lt;- lapply(x$env_state, </span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co">#                                          function(y) return(NA))</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">#                    </span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co"># })</span></span></code></pre></div>
</div>
<div id="insert-our-environmental-variation" class="section level2">
<h2>Insert our environmental variation</h2>
<p>Next, we’re going to insert our environmantal information using
<code>ipmr</code>’s <a href="https://levisc8.github.io/ipmr/reference/define_star.html"><code>define_env_state()</code></a>.
In the call to <code>sample_env()</code>, we set <code>index = t</code>.
<code>t</code> is an internal variable that <code>ipmr</code> defines to
track what timestep of the simulation it is currently on. This will
sample from the correct row of <code>use_env_data</code>. We also supply
the <code>use_env_data</code> object and <code>sample_env()</code>
function in the <code>data_list</code> slot so that they can be found
when the simulation runs.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the environemntal set up with the one we just created using ipmrs&#39;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># define_env_state.</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>protos<span class="sc">$</span>aaaa15_2 <span class="ot">&lt;-</span> <span class="fu">define_env_state</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  protos<span class="sc">$</span>aaaa15_2,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">env_vars =</span> <span class="fu">sample_env</span>(use_env_data, <span class="at">index =</span> t),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_list =</span> <span class="fu">list</span>(<span class="at">use_env_data =</span> use_env_data,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sample_env   =</span> sample_env)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="rebuild-the-models" class="section level2">
<h2>Rebuild the models</h2>
<p>We can rebuild the models now using <code>pdb_make_ipm()</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ipms <span class="ot">&lt;-</span> <span class="fu">pdb_make_ipm</span>(protos)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lambda</span>(ipms)</span></code></pre></div>
<pre><code>## $aaaa15
##     lambda 
## -0.1033479 
## 
## $aaaa16
##    lambda 
## 0.2710611 
## 
## $aaaa15_2
##     lambda 
## -0.1031656</code></pre>
<table style="width:70%;">
<caption>
Environmental covariate sequence from unaltered PADRINO data (first 10
iterations)
</caption>
<thead>
<tr>
<th style="text-align:right;">
j
</th>
<th style="text-align:right;">
A_max
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
6.885493
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5.606567
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
6.185809
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
5.683118
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6.073683
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5.216322
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
6.408164
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
6.350631
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6.722912
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6.100611
</td>
</tr>
</tbody>
</table>
<table style="width:70%;">
<caption>
Environmental covariate sequence from custom function (first 10
iterations)
</caption>
<thead>
<tr>
<th style="text-align:right;">
j
</th>
<th style="text-align:right;">
A_max
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
5.872700
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
7.091870
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5.454284
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6.470718
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5.086940
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
7.249801
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5.748229
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6.741378
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6.420061
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6.368241
</td>
</tr>
</tbody>
</table>
<p>And finally, a quick check to verify that our pre-defined sequence is
indeed the one that got used for <code>aaaa15_2</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(ipms<span class="sc">$</span>aaaa15_2<span class="sc">$</span>env_seq<span class="sc">$</span>j,     use_env_data<span class="sc">$</span>j) </span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(ipms<span class="sc">$</span>aaaa15_2<span class="sc">$</span>env_seq<span class="sc">$</span>A_max, use_env_data<span class="sc">$</span>A_max)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="modifying-parameter-values" class="section level1">
<h1>Modifying parameter values</h1>
<p>This is a bit simpler, because we just need to make some alterations
to a table, rather than creating new expressions. Unfortunately, we
can’t use the <code>parameters()&lt;-</code> interface for environmental
variation because that setter function does not modify the right place
in the <code>proto_ipm</code> object.</p>
<div id="identify-parameter-names" class="section level2">
<h2>Identify parameter names</h2>
<p>The <code>env_variable</code> column of the
<code>EnvironmentalVariables</code> usually provides a <em>very</em>
brief summary of what these parameters are, but not always. In general,
PADRINO notation in the <code>vr_expr_name</code> column mirrors the
publication notation. So to understand the meaning of
<code>A_max</code>, we need to consult the original publication
(Westerband, A. C., Horvitz, C. C. (2017). Photosynthetic rates
influence the population dynamics of understory herbs in stochastic
light environments. Ecology, 98 (2): 370-381). Upon doing this, we see
that <code>A_max</code> corresponds to photosynthetic capacity. For this
instance, we’ll pretend that we want to set the lower limit of
<code>A_max</code> to a smaller value, and the upper limit to a higher
value.</p>
<table>
<caption>EnvironmentalVariables table, subsetted using
‘stoch_ids’</caption>
<colgroup>
<col width="8%" />
<col width="15%" />
<col width="15%" />
<col width="12%" />
<col width="33%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">ipm_id</th>
<th align="left">env_variable</th>
<th align="left">vr_expr_name</th>
<th align="left">env_range</th>
<th align="left">env_function</th>
<th align="left">model_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">LightLevel</td>
<td align="left">j</td>
<td align="left">NULL</td>
<td align="left">sample(j_seq)</td>
<td align="left">Substituted</td>
</tr>
<tr class="even">
<td align="left">aaaa15</td>
<td align="left">LightLevel</td>
<td align="left">j_seq</td>
<td align="left">1:5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">A_max</td>
<td align="left">NULL</td>
<td align="left">Unif(a_max_low, a_max_high)</td>
<td align="left">Substituted</td>
</tr>
<tr class="even">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">a_max_low</td>
<td align="left">5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">a_max_high</td>
<td align="left">7</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="even">
<td align="left">aaaa16</td>
<td align="left">LightLevel</td>
<td align="left">j</td>
<td align="left">NULL</td>
<td align="left">sample(j_seq)</td>
<td align="left">Substituted</td>
</tr>
<tr class="odd">
<td align="left">aaaa16</td>
<td align="left">LightLevel</td>
<td align="left">j_seq</td>
<td align="left">1:5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="even">
<td align="left">aaaa16</td>
<td align="left">A_max</td>
<td align="left">A_max</td>
<td align="left">NULL</td>
<td align="left">Unif(a_max_low, a_max_high)</td>
<td align="left">Substituted</td>
</tr>
<tr class="odd">
<td align="left">aaaa16</td>
<td align="left">A_max</td>
<td align="left">a_max_low</td>
<td align="left">5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="even">
<td align="left">aaaa16</td>
<td align="left">A_max</td>
<td align="left">a_max_high</td>
<td align="left">8</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
</tbody>
</table>
<p>We can see that <code>A_max</code> is given by a Uniform distribution
with parameters <code>A_max_low</code> and <code>A_max_high</code>.
These two, as their names imply, are the lower and upper limits for
<code>A_max</code>, respectively. We can modify these just as we do any
other <code>data.frame</code>. We’ll create a copy of the
<code>pdb</code> object to modify, but you can modify it in place and
re-download an unaltered copy, or save the unaltered copy before
altering it to preserve the original version. Again, we’ll only modify
<code>aaaa15</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pdb_2 <span class="ot">&lt;-</span> pdb</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>inds <span class="ot">&lt;-</span> <span class="fu">which</span>(pdb_2<span class="sc">$</span>EnvironmentalVariables<span class="sc">$</span>vr_expr_name <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;a_max_&quot;</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                                                    <span class="fu">c</span>(<span class="st">&quot;low&quot;</span>, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="st">&quot;high&quot;</span>)) <span class="sc">&amp;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                pdb_2<span class="sc">$</span>EnvironmentalVariables<span class="sc">$</span>ipm_id <span class="sc">==</span> <span class="st">&quot;aaaa15&quot;</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>pdb_2<span class="sc">$</span>EnvironmentalVariables<span class="sc">$</span>env_range[inds[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># Bump min down two steps</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>pdb_2<span class="sc">$</span>EnvironmentalVariables<span class="sc">$</span>env_range[inds[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="dv">9</span> <span class="co"># Bump max up two steps</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The rest is the usual building workflow: make a proto_ipm, then convert to</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ipm.</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>new_protos <span class="ot">&lt;-</span> <span class="fu">pdb_make_proto_ipm</span>(pdb_2, <span class="st">&quot;aaaa15&quot;</span>)</span></code></pre></div>
<pre><code>## &#39;ipm_id&#39; aaaa15 has resampled parameters, resetting &#39;det_stoch&#39; to &#39;stoch&#39; and 
## &#39;kern_param&#39; to &#39;param&#39;!
## Default number of iterations for &#39;pdb_make_ipm&#39; will be 50. Modify this behavior 
## with the &#39;addl_args&#39; argument of &#39;pdb_make_ipm&#39;.</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>new_ipms   <span class="ot">&lt;-</span> <span class="fu">pdb_make_ipm</span>(new_protos)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lambda</span>(new_ipms)</span></code></pre></div>
<pre><code>## log(lambda) is returned by default for stochastic models. Set &#39;log = FALSE&#39; for lambda on linear scale.</code></pre>
<pre><code>## $aaaa15
##     lambda 
## -0.1032111</code></pre>
</div>
</div>
<div id="changing-distributions" class="section level1">
<h1>Changing distributions</h1>
<p>What if we want to change the distribution that a certain
environmental variable is sampled from? For example, rather than use a
uniform distribution, we decide we want to sample it from a Gamma
distribution. There are a couple steps we need to go through. They
are:</p>
<ol style="list-style-type: decimal">
<li><p>Write a function that substitutes distribution names. We can find
PADRINO’s distribution naming convention in the “Abbreviation” column <a href="https://github.com/padrinoDB/PADRINO/blob/main/metadata/digitization/dens_fun_dictionary.csv">here</a>.</p></li>
<li><p>Write a function to insert the new parameter values and names
into the <code>EnvironmentalVariables</code> Table.</p></li>
<li><p>Wrap 1-2 in a top-level function that we’ll actually
use.</p></li>
<li><p>Use it to modify <code>EnvironmentalVariables</code>, then
rebuild the IPMs using <code>pdb_make_proto_ipm()</code> and
<code>pdb_make_ipm()</code>.</p></li>
</ol>
<blockquote>
<p>NB: The functions we define in 1-3 will probably be incorporated into
<code>Rpadrino</code> at some point in the near future, but further
testing for stability is needed before they become part of the package.
As such, use them at your own risk!</p>
</blockquote>
<p>The function in 1 will make use of <code>rlang</code> to safely
modify function names and arguments. It is possible to do this with
<code>gsub(&quot;Unif&quot;, &quot;Gamma&quot;, pdb$EnvironmentalVariables$env_function[index])</code>
(where index is the row number of the function you want to update), but
could lead to unexpected results sometimes.</p>
<div id="top-level-function" class="section level2">
<h2>Top-level function</h2>
<p>This is probably the most straightforward of the functions to write.
We know that there two steps we have to implement that this wraps:
substitution the functioal form of the distribution, and substituting
the parameter values. Additionally, we’re going to insert a subsetting
capacity so that we can pass a larger database loop over a set of
<code>ipm_id</code>s to rapidly update many models at once.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>sub_env_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(db,          <span class="co"># pdb object</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                        parameter,   <span class="co"># parameter created by the distribution</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                        new_fun,     <span class="co"># The new distribution</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                        new_pars,    <span class="co"># The parameters for the new distribution</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">id =</span> <span class="cn">NULL</span>) { <span class="co"># ipm_id to operate on</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(id)) {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(id) <span class="sc">&gt;</span> 1L) <span class="fu">stop</span>(<span class="st">&quot;&#39;id&#39; should only have length 1!&quot;</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    db <span class="ot">&lt;-</span> <span class="fu">pdb_subset</span>(db, id)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  ev_tab <span class="ot">&lt;-</span> db<span class="sc">$</span>EnvironmentalVariables <span class="sc">%&gt;%</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sub_rng_fun</span>(parameter, new_fun, new_pars) <span class="sc">%&gt;%</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sub_rng_pars</span>(parameter, new_pars)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  db<span class="sc">$</span>EnvironmentalVariables <span class="ot">&lt;-</span> ev_tab</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(db)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="substituting-functions" class="section level2">
<h2>Substituting functions</h2>
<p>The first substituting function we’ll write is the one that
substitutes the distribution we wish to use into the
<code>env_function</code> column. This will use the names of the
<code>new_pars</code> object as arguments in a call to the
<code>new_fun</code> function. Don’t worry about finding the correct
<code>R</code> <code>r&lt;distribution&gt;</code> function here - we use
PADRINO’s syntax to modify these.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>sub_rng_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(ev_tab, parameter, new_fun, new_pars) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the old function form</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  old_fun_ind <span class="ot">&lt;-</span> <span class="fu">which</span>(ev_tab<span class="sc">$</span>vr_expr_name <span class="sc">==</span> parameter)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a new function call, and insert new arguments</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  arg_nms     <span class="ot">&lt;-</span> <span class="fu">syms</span>(<span class="fu">names</span>(new_pars))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  new_fun     <span class="ot">&lt;-</span> <span class="fu">call2</span>(new_fun, <span class="sc">!!!</span> <span class="fu">syms</span>(<span class="fu">names</span>(new_pars)))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert back to a string and insert into the table</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  ev_tab<span class="sc">$</span>env_function[old_fun_ind] <span class="ot">&lt;-</span> <span class="fu">expr_text</span>(new_fun)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ev_tab)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>There is a lot going on in this function, and most of it is beyond
the scope of this vignette (if you’re curious about the details, see the
<code>Metaprogramming</code> topics <a href="https://rlang.r-lib.org/index.html">here</a>). The key takeaway is
that we take our new function, <code>&quot;Gamma&quot;</code> and convert it into
a function call with arguments that are named after
<code>new_pars</code>. Then we stick it back into the table, overwriting
the old <code>&quot;Unif&quot;</code> function.</p>
<p>Adding a parameter value to the table is far less complicated. First,
we remove the parameters associated with the old distribution. We have
to do this because of the way that <code>Rpadrino</code> finds the
parameters to functions in the <code>EnvironmentalVariables</code>
table. The first lines of the function accomplish this. After that, we
create a version of the <code>EnvironmentalVariables</code> table that
contains our new parameters and add those back in.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sub_rng_pars <span class="ot">&lt;-</span> <span class="cf">function</span>(ev_tab, parameter, new_pars) { </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove the existing parameters associated with the distribution</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># that we&#39;ve replaced.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(ev_tab<span class="sc">$</span>env_variable <span class="sc">==</span> parameter) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    rm_ind <span class="ot">&lt;-</span> ev_tab<span class="sc">$</span>env_variable <span class="sc">==</span> parameter <span class="sc">&amp;</span> ev_tab<span class="sc">$</span>model_type <span class="sc">==</span> <span class="st">&quot;Parameter&quot;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    ev_tab <span class="ot">&lt;-</span> ev_tab[<span class="sc">!</span>rm_ind, ]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  new_rows <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">ipm_id       =</span> <span class="fu">rep</span>(<span class="fu">unique</span>(ev_tab<span class="sc">$</span>ipm_id), <span class="fu">length</span>(new_pars)),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">env_variable =</span> <span class="fu">rep</span>(parameter, <span class="fu">length</span>(new_pars)),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">vr_expr_name =</span> <span class="fu">names</span>(new_pars),</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">env_range    =</span> <span class="fu">unlist</span>(new_pars),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">env_function =</span> <span class="fu">rep</span>(<span class="st">&quot;NULL&quot;</span>, <span class="fu">length</span>(new_pars)),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_type   =</span> <span class="st">&quot;Parameter&quot;</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(new_rows) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(ev_tab, new_rows)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>small_pdb <span class="ot">&lt;-</span> pdb <span class="sc">%&gt;%</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pdb_subset</span>(<span class="st">&quot;aaaa15&quot;</span>)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>new_pdb <span class="ot">&lt;-</span> <span class="fu">sub_env_fun</span>(<span class="at">db =</span> small_pdb, </span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">id =</span> <span class="cn">NULL</span>, </span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;A_max&quot;</span>,</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Gamma&quot;</span>, </span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">list</span>(<span class="at">a_max_shape =</span> <span class="dv">14</span>, <span class="at">a_max_rate =</span> <span class="fl">3.5</span>))</span></code></pre></div>
<table>
<caption>New ‘EnvironmentalVariables’ table</caption>
<colgroup>
<col width="8%" />
<col width="15%" />
<col width="15%" />
<col width="11%" />
<col width="36%" />
<col width="13%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">ipm_id</th>
<th align="left">env_variable</th>
<th align="left">vr_expr_name</th>
<th align="left">env_range</th>
<th align="left">env_function</th>
<th align="left">model_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">LightLevel</td>
<td align="left">j</td>
<td align="left">NULL</td>
<td align="left">sample(j_seq)</td>
<td align="left">Substituted</td>
</tr>
<tr class="even">
<td align="left">aaaa15</td>
<td align="left">LightLevel</td>
<td align="left">j_seq</td>
<td align="left">1:5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">A_max</td>
<td align="left">NULL</td>
<td align="left">Gamma(a_max_shape, a_max_rate)</td>
<td align="left">Substituted</td>
</tr>
<tr class="even">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">a_max_shape</td>
<td align="left">14</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
<tr class="odd">
<td align="left">aaaa15</td>
<td align="left">A_max</td>
<td align="left">a_max_rate</td>
<td align="left">3.5</td>
<td align="left">NULL</td>
<td align="left">Parameter</td>
</tr>
</tbody>
</table>
<p>Notice that our new Gamma distribution parameters have found their
way into the parameter table. We can now rebuild the model as using the
same pipeline as above.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>new_ipm <span class="ot">&lt;-</span> new_pdb <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pdb_make_proto_ipm</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pdb_make_ipm</span>()</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lambda</span>(new_ipm)</span></code></pre></div>
<pre><code>## $aaaa15
##    lambda 
## -0.102334</code></pre>
<p>It is probably ok to copy/paste the functions we defined above and
apply to in your own analyses. However, as they are not yet incorporated
into <code>Rpadrino</code>, I cannot promise that the results will be
error free.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
